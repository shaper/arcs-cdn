<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../components/xen/xen.html">
<link rel="import" href="../../components/toggle-button.html">
<link rel="import" href="../../components/explorer-hotkey.html">
<link rel="import" href="../../components/corellia-xen/cx-input.html">

<link rel="import" href="arc-config.html">
<link rel="import" href="arc-auth.html">
<link rel="import" href="arc-view.html">
<link rel="import" href="arc-host.html">
<link rel="import" href="arc-footer.html">
<link rel="import" href="arc-steps.html">
<link rel="import" href="arc-store.html">
<link rel="import" href="persistent-users.html">
<link rel="import" href="persistent-user.html">
<link rel="import" href="persistent-arc.html">
<link rel="import" href="persistent-views.html">

<template>
  <style>
    arc-app, [arc-app] {
      display: block;
    }
    i {
      font-family: 'Material Icons';
      font-size: 24px;
      font-style: normal;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
      vertical-align: middle;
      cursor: pointer;
    }
    toolbar {
      display: block;
      height: 40px;
    }
    app-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      display: flex;
      align-items: center;
      white-space: nowrap;
      padding-left: 12px;
      /*padding: 0 8px;*/
      box-sizing: border-box;
      background-color: whitesmoke;
      z-index: 1000;
      transform: translate(0,0,0); /* makes it a layer so other layers scroll underneath, is there a better way? */
    }
    app-toolbar > * {
      padding-right: 12px;
    }
    app-toolbar > select {
      padding: 2px 0;
      margin-right: 8px;
      width: 128px;
    }
    [arc-title] {
      flex: 1;
      min-height: 0.6em;
      padding-top: 0.1em;
    }
    arc-footer {
      height: 40px;
    }
  </style>

  <toolbar>
    <app-toolbar>
      <i style="color: #9c27b0;" on-click="_onNavClick">donut_small</i>
      <span arc-title style%="{{titleStatic}}" on-click="_onStartEditingTitle" unsafe-html="{{description}}"></span>
      <i on-click="_onNewClick">note_add</i>

      <select on-change="_onUserSelected">{{usersOptions}}</select>
      <template users-options>
        <option value="{{value}}" selected="{{selected}}">{{user}}</option>
      </template>

      <toggle-button state="{{profileState}}" on-state="_onProfileState" icons="person_outline person"></toggle-button>
      <toggle-button state="{{sharingState}}" on-state="_onSharingState" icons="link supervisor_account"></toggle-button>
      <toggle-button on-state="_onCastState" icons="cast cast_connected"></toggle-button>
    </app-toolbar>
  </toolbar>

  <arc-auth on-auth="_onAuth"></arc-auth>

  <persistent-users arc="{{arc}}" on-users="_onUsers"></persistent-users>
  <persistent-user id="{{userId}}" key="{{key}}" user="{{user}}" on-user="_onUser" on-arcs="_onUserArcs"></persistent-user>
  <persistent-arc description="{{description}}" key="{{key}}" on-key="_onKey" metadata="{{metadata}}" on-metadata="_onMetadata"></persistent-arc>
  <persistent-views key="{{key}}" arc="{{arc}}"></persistent-views>

  <arc-config rootpath="{{cdnPath}}" on-config="_onConfig"></arc-config>

<!--
  <arc-store arc="{{arc}}" on-arcs="_onArcsList" key="{{key}}" on-key="_onKey" metadata="{{metadata}}" on-metadata="_onMetadata" users="{{users}}" on-users="_onUsersList"></arc-store>
-->

  <arc-steps plans="{{plans}}" plan="{{plan}}" steps="{{steps}}" step="{{step}}" on-step="_onStep" on-steps="_onSteps"></arc-steps>

  <arc-view arc="{{arc}}" data="{{arcsViewData}}" options="{{arcsViewOptions}}" on-view="_onArcsView"></arc-view>
  <arc-view arc="{{arc}}" data="{{identityViewData}}" options="{{identityViewOptions}}" on-view="_onIdentityView"></arc-view>
  <arc-view arc="{{arc}}" data="{{identitiesViewData}}" options="{{identitiesViewOptions}}" on-view="_onIdentitiesView"></arc-view>

  <arc-host config="{{config}}" plans="{{plans}}" plan="{{plan}}" on-arc="_onArc" on-plans="_onPlans" on-applied="_onApplied">
    <div slotid="toproot"></div>
    <div slotid="root"></div>
  </arc-host>

  <arc-footer suggestions="{{plans}}" on-suggest="_onSuggest"></arc-footer>

</template>

<script>
  class ArcApp extends XenBase {
    get host() {
      // TODO(sjmiles): override shadow-root generation so that
      // old-timey systems (e.g. TradingView widgets) can find
      // various bits in `document` when used in Particles.
      // Using light-dom opens up style leakage concerns.
      return this;
    }
    _getInitialState() {
      let cdnPath = ArcApp.module.URL.split('/').slice(0, -3).join('/');
      return {
        userName: 'Scott',
        needPlans: true,
        cdnPath,
        icons: {
          profileStateIcon: `person_outline`,
          sharedStateIcon: `link`,
          castIcon: `cast`
        },
        arcsViewOptions: {
          schemas: `${cdnPath}/app-shell.2/artifacts/arc-types.manifest`,
          type: '[ArcMetadata]',
          name: 'ArcMetadata',
          tags: ['#arcmetadata']
        },
        identityViewOptions: {
          schemas: `${cdnPath}/app-shell.2/artifacts/identity-types.manifest`,
          type: 'Person',
          name: 'Identity',
          tags: ['#identity']
        },
        identitiesViewOptions: {
          schemas: `${cdnPath}/app-shell.2/artifacts/identity-types.manifest`,
          type: '[Person]',
          name: 'Identities',
          tags: ['#identities']
        }
      }
    }
    _didMount() {
      this._meta = this.host.querySelector('arc-metadata');
      this._store = this.host.querySelector('arc-store');
    }
    _update(props, state) {
      if (!state.identityViewData && state.auth && state.arc) {
        state.identityViewData = this._synthesizeIdentityViewData(state.arc, state.userName);
      }
      if (!state.plan && state.plans && state.plans.length && state.config.launcher) {
        state.plan = state.plans[0].plan;
      }
      if (state.user) {
        state.id = state.user.id;
        state.userName = state.user.name;
      }
      if (state.key) {
        Arcs.utils.setUrlParam('arc', state.key);
      }
      if (state.user && state.key) {
        state.profileState = state.user.profiles[state.key] ? 1 : 0;
      }
      super._update(props, state);
    }
    _render(props, state) {
      if (state.users) {
        state.usersOptions = {
          $template: 'users-options',
          models: this._renderUserOptionModels(state.users, state.user)
        }
      }
      if (state.metadata) {
        state.description = state.metadata.description;
        state.steps =  state.metadata.steps;
      }
      return [
        state.icons,
        state.auth ? state : null
      ];
    }
    _renderUserOptionModels(users, user) {
      let selectedId = user ? user.id : '';
      return [
        {user: '(none)'},
        {user: '(Create User)'}
      ].concat(
        Object.keys(users).map(id => {
          return {
            value: id,
            user: users[id].name,
            selected: id == selectedId
          }
        })
      );
    }
    _hasViews(state) {
      return Boolean(state.view && state.identityView && state.identitiesView);
    }
    _onConfig(e, config) {
      let key = config.key || '';
      if (!config.key) {
        config.key = 'launcher';
      }
      if (config.key === 'profile') {
        config.soloPath = 'profile.manifest';
      }
      if (config.key === 'launcher') {
        config.soloPath = config.soloPath || 'launcher.manifest';
        config.launcher = true;
        //this._setState({description: 'Arc Launcher'});
        key = '';
      }
      this._setState({config, key, userId: config.user});
    }
    _onAuth(e, auth) {
      this._setState({auth});
    }
    _onUsers(e, users) {
      if (users !== this._state.users) {
        this._setState({users, identitiesViewData: users});
      }
    }
    _onUserSelected(e) {
      let id;
      let selected = e.currentTarget.selectedIndex;
      switch (selected) {
        case 0:
          break;
        case 1:
          id = db.child('users').push().key;
          break;
        default:
          id = e.currentTarget.value
          break;
      }
      ArcApp.log('switching user', id);
      this._setState({user: null, userId: id});
    }
    _onUser(e, user, props, state) {
      if (user && (!user.name || user.name === 'Anonymous')) {
        // returns String 'null' (sheesh) on cancel
        let name = prompt('User name?', 'User');
        if (name !== "null") {
          // `user` is immutable, must copy-on-write
          user = Object.assign(Object.create(null), user);
          user.name = name;
        }
      }
      // reference testing, remember to treat `user` as immutable
      if (state.user != user) {
        this._setState({user});
        if (user) {
          localStorage.setItem('currentUser', user.id);
        }
      }
    }
    _onUserArcs(e, userArcs) {
      this._setState({
        arcsViewData: Object.keys(userArcs).map(key => {
          let arc = userArcs[key];
          return {
            key: key,
            description: arc.description || key.slice(1),
            icon: arc.icon || 'broken_image',
            color: arc.color || 'gray',
            href: `${location.origin}${location.pathname}?arc=${key}`
          };
        })
      });
    }
    _onNewClick(e) {
      open(`${location.origin}${location.pathname}`, `_blank`);
    }
    _onKey(e, key) {
      this._setState({key});
    }
    _onArc(e, arc) {
      window.arc = arc;
      this._setState({arc});
    }
    _onArcsView(e, view) {
      if (this._state.view !== view) {
        ArcApp.log('ArcsView', view);
        this._setState({view, plans: null});
      }
    }
    _onIdentityView(e, identityView) {
      if (this._state.identityView !== identityView) {
        ArcApp.log('IdentityView', identityView);
        this._setState({identityView, plans: null});
      }
    }
    _onIdentitiesView(e, identitiesView) {
      if (this._state.identitiesView !== identitiesView) {
        ArcApp.log('IdentitiesView', identitiesView);
        this._setState({identitiesView, plans: null});
      }
    }
    _onMetadata(e, metadata) {
      if (this._state.metadata !== metadata) {
        this._setState({metadata});
      }
    }
    _onProfileState(e, profileState) {
      ArcApp.log('profile state changed', profileState);
      let {users, user, key} = this._state;
      if (user) {
        user.profiles = user.profiles || Object.create(null);
        if (profileState) {
          user.profiles[key] = true;
        } else {
          delete user.profiles[key];
        }
        ArcApp.log('mutate user/users list', user, users);
        this._setState({
          user: Object.assign(Object.create(null), user),
          users: Object.assign(Object.create(null), users)
        });
      }
    }
    _onSteps(e, steps) {
      this._updateMetadata({steps});
    }
    _onPlans(e, plans) {
      if (plans !== this._state.plans) {
        this._setState({plans});
        this._fire('generations', plans.generations, document);
        //document.dispatchEvent(new CustomEvent('generations', {detail: plans.generations}));
      }
    }
    _onStep(e, step) {
      this._setState({plan: step.plan});
    }
    _onSuggest(e, suggestion) {
      this._setState({plan: suggestion.plan});
    }
    _onApplied(e, plan, props, state) {
      let description = utils.describeArc(state.arc);
      if (!description && !state.description) {
        description = utils.randomName();
      }
      if (description && description !== state.description) {
        this._updateMetadata({description});
        this._setState({description});
      } else {
        // TODO(sjmiles): reason?
        this._invalidate();
      }
    }
    _synthesizeIdentityViewData(arc, user) {
      return {id: arc.generateID(), rawData: user};
    }
    _updateMetadata(data) {
      let {metadata} = this._state;
      if (metadata && data) {
        // `metadata` is considered immutable downstream (have to make a new reference or it's not considered changed)
        metadata = Object.assign(Object.assign(Object.create(null), metadata), data);
        // set new object to state
        this._setState({metadata});
      }
    }
  }
  ArcApp.module = document.currentImport;
  ArcApp.log = XenBase.logFactory('ArcApp', '#bb4d00');
  customElements.define('arc-app', ArcApp);
</script>