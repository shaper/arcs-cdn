<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<script>
  class RemoteViews extends XenBase {
    static get observedAttributes() { return ['arc', 'key', 'profiles']; }
    get _db() {
      return db;
    }
    _update(props, state, lastProps) {
      if (props.key && lastProps.key !== props.key) {
        state.needsWatch = true;
      }
      if (props.arc && state.needsWatch) {
        state.needsWatch = false;
        this._watchViews(props.key, props.arc, props.profiles);
      }
    }
    _watchViews(key, arc, areProfiles) {
      let node = this._db.child(`arcs/${key}/views`);
      this._off && this._off();
      let handle = node.on('value', this._arcData.bind(this, arc, areProfiles));
      this._off = () => node.off('value', handle);
    }
    _arcData(arc, areProfiles, snap) {
      let arcKey = '-key';
      let views = snap.val();
      RemoteViews.log('(incoming)', snap.key, views);
      if (views) {
        Object.keys(views).forEach(key => {
          let remote = views[key];
          let meta = remote.metadata;
          //RemoteViews.log('creating type from', meta);
          // construct type object
          let type = new Arcs.Type(meta.type.tag, meta.type.data);
          //RemoteViews.log('type', type);
          // construct id
          let id = this._getContextViewId(type, meta.tags, arcKey, areProfiles);
          // find or create a view in the arc context
          let view = arc.context.newView(type, meta.name, id, meta.tags);
          Arcs.utils.setViewData(view, remote.values);
          RemoteViews.log('created view', id);
          this._fire('view', view);
        });
      }
    }
    // Returns the context view id for the given params.
    _getContextViewId(type, tags, amkey, isProfile) {
      return ''
        + `${isProfile ? `PROFILE/` : `AMKEY${amkey}/`}`
        + `${type.toString().replace(' ', '-')}/`
        + ((tags && [...tags].length) ? `${[...tags].sort().join('-').replace(/#/g, '')}/` : '')
        ;
    }
  }
  RemoteViews.module = document.currentImport;
  RemoteViews.log = XenBase.logFactory('RemoteViews', '#aa00c7');
  customElements.define('remote-views', RemoteViews);
</script>
