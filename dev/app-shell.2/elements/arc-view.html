<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<script>
  class ArcView extends XenBase {
    static get observedAttributes() { return ['arc', 'options', 'data']; }
    _update(props, state, lastProps) {
      let lastData = lastProps.data;
      let {arc, options, data} = props;
      if (arc && !state.view) {
        if (!state.manifest && options && options.schemas) {
          Arcs.Manifest.load(options.schemas, arc.loader).then(manifest => this._setState({manifest}));
        }
        if (state.manifest && options) {
          state.view = this._createView(arc, state.manifest, options);
        }
        lastData = null;
      }
      if (state.view && data != lastData) {
        // (re)populate
        this._updateView(state.view, data, arc);
        //this._fire('view', state.view);
      }
    }
    _createView(arc, manifest, {name, tags, type}) {
      let viewOf = false;
      if (type[0] == '[') {
        viewOf = true;
        type = type.slice(1, -1);
      }
      let schema = manifest.findSchemaByName(type);
      let typeOf = viewOf ? schema.type.viewOf() : schema.type;
      tags = ['#nosync'].concat(tags);
      // manifest-view, for `map`, `copy`, `?`
      //let view = manifest.newView(type, name, arc.generateID(), ['#identities']);
      // arc-view, suitable for `use`, `?`
      let view = arc.createView(typeOf, name, arc.generateID(), tags);
      // observe view
      view.on('change', change => {
        //ArcView.log('arcsView change detected', change);
        this._fire('view', view);
      }, {});
      ArcView.log('created view', name, tags);
      return view;
    }
    _updateView(view, data, arc) {
      //ArcView.log(`updateView: [${view.name}]`, data);
      if (view.toList) {
        view.toList().forEach(entity => {
          view.remove(entity.id);
        });
        for (let key in data) {
          view.store({id: arc.generateID(), rawData: data[key]});
        }
      } else {
        view.set({id: arc.generateID(), rawData: data});
      }
    }
  }
  ArcView.module = document.currentImport;
  ArcView.log = XenBase.logFactory('ArcView', '#c6a700');
  customElements.define('arc-view', ArcView);
</script>
